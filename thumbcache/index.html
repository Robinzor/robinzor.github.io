<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thumbcache Viewer</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #222;
            color: #fff;
            text-align: center;
            padding: 20px;
        }
        input {
            margin: 20px;
        }
        .thumbnails {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }
        .thumbnail {
            border: 1px solid #fff;
            padding: 5px;
            background: #444;
        }
        img {
            max-width: 150px;
            height: auto;
        }
        .file-path {
            margin-top: 10px;
            font-size: 14px;
            color: #ccc;
        }
        .default-path {
            margin-top: 5px;
            font-size: 12px;
            color: #888;
        }
        .progress-container {
            width: 80%;
            background: #444;
            margin: 20px auto;
            height: 20px;
            border-radius: 10px;
            overflow: hidden;
        }
        .progress-bar {
            height: 100%;
            width: 0%;
            background: #4caf50;
            transition: width 0.2s;
        }
    </style>
</head>
<body>
    <h1>Thumbcache Viewer</h1>
    <input type="file" id="fileInput" accept=".db" />
    <div class="file-path" id="filePath">No file selected</div><br>
    <div class="default-path">Directory: <br> C:\Users\%Username%\AppData\Local\Microsoft\Windows\Explorer\ <br><br> Filename: <br> thumbcache_*.db   </div>
    <div class="progress-container"><div class="progress-bar" id="progressBar"></div></div>
    <div class="thumbnails" id="thumbnails"></div>
    
    <script>
        document.getElementById('fileInput').addEventListener('change', handleFile);
        
        function handleFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            console.log(`[Thumbcache Viewer] Loaded file: ${file.name}`);
            document.getElementById('filePath').textContent = `File: ${file.name}`;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                parseThumbcache(new Uint8Array(e.target.result));
            };
            reader.readAsArrayBuffer(file);
        }
        
        function parseThumbcache(data) {
            console.log("[Thumbcache Viewer] Parsing thumbcache...");
            const thumbnailsContainer = document.getElementById('thumbnails');
            thumbnailsContainer.innerHTML = "";
            
            let offset = 0;
            let imagesFound = 0;
            const totalSize = data.length;
            const progressBar = document.getElementById('progressBar');
            const imageElements = [];
            
            function processChunk() {
                const chunkSize = 100000; 
                const end = Math.min(offset + chunkSize, totalSize);
                
                while (offset < end) {
                    if (data[offset] === 0x42 && data[offset + 1] === 0x4D) {
                        console.log(`[Thumbcache Viewer] BMP image detected at offset ${offset}`);
                        const endOffset = findImageEnd(data, offset, 'BMP');
                        displayImage(data.slice(offset, endOffset), 'image/bmp', imageElements);
                        offset = endOffset;
                        imagesFound++;
                    } else if (data[offset] === 0x89 && data[offset + 1] === 0x50 && 
                               data[offset + 2] === 0x4E && data[offset + 3] === 0x47) {
                        console.log(`[Thumbcache Viewer] PNG image detected at offset ${offset}`);
                        const endOffset = findImageEnd(data, offset, 'PNG');
                        displayImage(data.slice(offset, endOffset), 'image/png', imageElements);
                        offset = endOffset;
                        imagesFound++;
                    } else if (data[offset] === 0xFF && data[offset + 1] === 0xD8 && 
                               data[offset + 2] === 0xFF) {
                        console.log(`[Thumbcache Viewer] JPEG image detected at offset ${offset}`);
                        const endOffset = findImageEnd(data, offset, 'JPEG');
                        displayImage(data.slice(offset, endOffset), 'image/jpeg', imageElements);
                        offset = endOffset;
                        imagesFound++;
                    } else {
                        offset++;
                    }
                }
                
                progressBar.style.width = `${(offset / totalSize) * 100}%`;
                
                if (offset < totalSize) {
                    requestAnimationFrame(processChunk);
                } else {
                    imageElements.forEach(img => thumbnailsContainer.appendChild(img));
                    console.log(`[Thumbcache Viewer] Extraction complete. ${imagesFound} images found.`);
                }
            }
            
            requestAnimationFrame(processChunk);
        }
        
        function findImageEnd(data, start, format) {
            if (format === 'PNG') {
                for (let i = start + 8; i < data.length - 8; i++) {
                    if (data[i] === 0x49 && data[i + 1] === 0x45 && data[i + 2] === 0x4E && data[i + 3] === 0x44) {
                        return i + 8;
                    }
                }
            } else if (format === 'JPEG') {
                for (let i = start + 2; i < data.length - 2; i++) {
                    if (data[i] === 0xFF && data[i + 1] === 0xD9) {
                        return i + 2;
                    }
                }
            } else if (format === 'BMP') {
                if (start + 4 < data.length) {
                    return start + (data[start + 2] | (data[start + 3] << 8) | (data[start + 4] << 16) | (data[start + 5] << 24));
                }
            }
            return start + 1;
        }
        
        function displayImage(blobData, mimeType, imageElements) {
            const blob = new Blob([blobData], { type: mimeType });
            const img = document.createElement('img');
            img.src = URL.createObjectURL(blob);
            img.classList.add('thumbnail');
            imageElements.push(img);
        }
    </script>
</body>
</html>
